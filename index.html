<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IG 九宮格模擬器 (Cropper.js)</title>
<link href="https://cdn.jsdelivr.net/npm/cropperjs@1.5.13/dist/cropper.min.css" rel="stylesheet"/>
<style>
body { font-family: Arial; background:#f7f7f7; display:flex; flex-direction:column; align-items:center; padding:20px;}
h1{ text-align:center; margin-bottom:20px;}
.grid { display:grid; grid-template-columns: repeat(3, 1fr); gap:2px; width:360px; }
.grid-item { position:relative; width:100%; padding-top:125%; background:#ddd; cursor:pointer; overflow:hidden; }
.grid-item img { position:absolute; top:0; left:0; width:100%; height:100%; object-fit:cover; }
.menu { position:absolute; background:#fff; border:1px solid #ccc; border-radius:5px; display:none; z-index:100; }
.menu button { display:block; width:100%; border:none; background:none; padding:5px 10px; cursor:pointer; text-align:left; }
.menu button:hover { background:#f0f0f0; }
#fileInput { display:none; }
#cropModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.8); justify-content:center; align-items:center; }
#cropContainer { background:#fff; padding:10px; border-radius:5px; position:relative; max-width:90%; max-height:90%; display:flex; flex-direction:column; align-items:center;}
#cropImageElem { max-width:100%; max-height:80vh; }
#cropBtns { margin-top:5px; text-align:right; }
#cropBtns button { margin-left:5px; }
</style>
</head>
<body>
<h1>IG 九宮格模擬器 (Cropper.js)</h1>

<div class="grid" id="grid"></div>
<input type="file" id="fileInput" accept="image/*">

<div id="cellMenu" class="menu">
  <button id="changeImage">更換圖片</button>
  <button id="cropImage">裁切圖片</button>
</div>

<div id="cropModal">
  <div id="cropContainer">
    <img id="cropImageElem">
    <div id="cropBtns">
      <button id="cancelCrop">取消</button>
      <button id="applyCrop">確定裁切</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/cropperjs@1.5.13/dist/cropper.min.js"></script>
<script>
const grid = document.getElementById('grid');
const fileInput = document.getElementById('fileInput');
const cellMenu = document.getElementById('cellMenu');
let currentCell = null;
let cropper = null;

// 初始化九宮格
let gridOrder = JSON.parse(localStorage.getItem('ig_grid_order')) || Array.from({length:9},(_,i)=>i);
for(let i=0;i<9;i++){
  const div=document.createElement('div');
  div.className='grid-item';
  div.dataset.index=gridOrder[i];
  const img=document.createElement('img');
  div.appendChild(img);
  grid.appendChild(div);

  // 載入 localStorage 的圖片
  const saved = localStorage.getItem('ig_grid_'+gridOrder[i]);
  if(saved) img.src = saved;

  // 點擊格子彈出選單
  div.addEventListener('click',(e)=>{
    currentCell=div;
    const rect=div.getBoundingClientRect();
    cellMenu.style.top = rect.bottom + window.scrollY + 'px';
    cellMenu.style.left = rect.left + window.scrollX + 'px';
    cellMenu.style.display='block';
  });

  // 拖曳排序
  div.draggable = true;
  div.addEventListener('dragstart',(e)=>{
    e.dataTransfer.setData('text/plain', div.dataset.index);
  });
  div.addEventListener('dragover',(e)=>{ e.preventDefault(); });
  div.addEventListener('drop',(e)=>{
    e.preventDefault();
    let fromIndex = e.dataTransfer.getData('text/plain');
    let toIndex = div.dataset.index;
    swapGrid(fromIndex,toIndex);
  });
}

// 點擊空白處隱藏選單
document.addEventListener('click',(e)=>{
  if(!grid.contains(e.target) && !cellMenu.contains(e.target)){
    cellMenu.style.display='none';
  }
});

// 更換圖片
document.getElementById('changeImage').addEventListener('click',()=>{
  cellMenu.style.display='none';
  fileInput.click();
});
fileInput.addEventListener('change',e=>{
  if(e.target.files.length==0) return;
  const file=e.target.files[0];
  const reader=new FileReader();
  reader.onload=function(ev){
    currentCell.querySelector('img').src = ev.target.result;
    localStorage.setItem('ig_grid_'+currentCell.dataset.index, ev.target.result);
    localStorage.setItem('original_ig_grid_'+currentCell.dataset.index, ev.target.result); // 存原圖
  }
  reader.readAsDataURL(file);
  fileInput.value='';
});

// 裁切圖片
document.getElementById('cropImage').addEventListener('click',()=>{
  cellMenu.style.display='none';
  const index = currentCell.dataset.index;
  const originalSrc = localStorage.getItem('original_ig_grid_'+index);
  if(originalSrc){
    openCrop(originalSrc);
  } else {
    openCrop(currentCell.querySelector('img').src);
  }
});

// 打開裁切視窗
const cropModal = document.getElementById('cropModal');
const cropImageElem = document.getElementById('cropImageElem');

function openCrop(src){
  cropImageElem.src = src;
  cropModal.style.display='flex';
  if(cropper) cropper.destroy();
  cropper = new Cropper(cropImageElem, {
    aspectRatio: 4/5,
    viewMode: 1,
    autoCropArea: 1,
    movable: true,
    zoomable: true,
    scalable: false,
    background: false,
    responsive: true,
    minContainerWidth: 300,
    minContainerHeight: 300
  });
}

// 取消裁切
document.getElementById('cancelCrop').addEventListener('click',()=>{
  cropModal.style.display='none';
  if(cropper) cropper.destroy();
});

// 確定裁切
document.getElementById('applyCrop').addEventListener('click',()=>{
  if(cropper){
    const canvas = cropper.getCroppedCanvas({width:400, height:500});
    currentCell.querySelector('img').src = canvas.toDataURL();
    localStorage.setItem('ig_grid_'+currentCell.dataset.index, canvas.toDataURL());
    cropModal.style.display='none';
    cropper.destroy();
  }
});

// 拖曳排序交換
function swapGrid(fromIndex,toIndex){
  if(fromIndex===toIndex) return;
  let fromDiv = Array.from(grid.children).find(d=>d.dataset.index==fromIndex);
  let toDiv = Array.from(grid.children).find(d=>d.dataset.index==toIndex);
  let fromImg = fromDiv.querySelector('img').src;
  let toImg = toDiv.querySelector('img').src;
  fromDiv.querySelector('img').src = toImg;
  toDiv.querySelector('img').src = fromImg;
  localStorage.setItem('ig_grid_'+fromDiv.dataset.index, fromDiv.querySelector('img').src);
  localStorage.setItem('ig_grid_'+toDiv.dataset.index, toDiv.querySelector('img').src);

  let order = Array.from(grid.children).map(d=>parseInt(d.dataset.index));
  localStorage.setItem('ig_grid_order', JSON.stringify(order));
}
</script>
</body>
</html>
