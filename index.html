<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IG 九宮格模擬器 + 拖曳 + 裁切 + 記憶</title>
<style>
body { font-family: Arial; background:#f7f7f7; display:flex; flex-direction:column; align-items:center; padding:20px;}
h1{ text-align:center; margin-bottom:20px;}
.grid { display:grid; grid-template-columns: repeat(3, 1fr); gap:2px; width:360px; }
.grid-item { position:relative; width:100%; padding-top:125%; background:#ddd; cursor:pointer; overflow:hidden; }
.grid-item img { position:absolute; top:0; left:0; width:100%; height:100%; object-fit:cover; }
.menu { position:absolute; background:#fff; border:1px solid #ccc; border-radius:5px; display:none; z-index:100; }
.menu button { display:block; width:100%; border:none; background:none; padding:5px 10px; cursor:pointer; text-align:left; }
.menu button:hover { background:#f0f0f0; }
#fileInput { display:none; }
#cropModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.8); justify-content:center; align-items:center; }
#cropContainer { background:#fff; padding:10px; border-radius:5px; position:relative; }
#cropCanvas { border:1px solid #ccc; cursor: crosshair; }
#cropBtns { margin-top:5px; text-align:right; }
#cropBtns button { margin-left:5px; }
</style>
</head>
<body>
<h1>IG 九宮格模擬器</h1>

<div class="grid" id="grid"></div>
<input type="file" id="fileInput" accept="image/*">

<!-- 操作選單 -->
<div id="cellMenu" class="menu">
  <button id="changeImage">更換圖片</button>
  <button id="cropImage">裁切圖片</button>
</div>

<!-- 裁切彈窗 -->
<div id="cropModal">
  <div id="cropContainer">
    <canvas id="cropCanvas"></canvas>
    <div id="cropBtns">
      <button id="cancelCrop">取消</button>
      <button id="applyCrop">確定裁切</button>
    </div>
  </div>
</div>

<script>
const grid = document.getElementById('grid');
const fileInput = document.getElementById('fileInput');
const cellMenu = document.getElementById('cellMenu');
let currentCell = null;

// 裁切
let cropModal = document.getElementById('cropModal');
let cropCanvas = document.getElementById('cropCanvas');
let ctx = cropCanvas.getContext('2d');
let imgObj = null;
let cropX=50, cropY=50, cropW=200, cropH=250;
let isDragging=false,dragOffsetX=0,dragOffsetY=0;
let isResizing=false,resizeStart={};

// 初始化九宮格
let gridOrder = JSON.parse(localStorage.getItem('ig_grid_order')) || Array.from({length:9},(_,i)=>i);
for(let i=0;i<9;i++){
  const div=document.createElement('div');
  div.className='grid-item';
  div.dataset.index=gridOrder[i];
  const img=document.createElement('img');
  div.appendChild(img);
  grid.appendChild(div);

  // 載入 localStorage 的圖片
  const saved = localStorage.getItem('ig_grid_'+gridOrder[i]);
  if(saved) img.src = saved;

  // 點擊格子彈出選單
  div.addEventListener('click',(e)=>{
    currentCell=div;
    const rect=div.getBoundingClientRect();
    cellMenu.style.top = rect.bottom + window.scrollY + 'px';
    cellMenu.style.left = rect.left + window.scrollX + 'px';
    cellMenu.style.display='block';
  });

  // 拖曳排序
  div.draggable = true;
  div.addEventListener('dragstart',(e)=>{
    e.dataTransfer.setData('text/plain', div.dataset.index);
  });
  div.addEventListener('dragover',(e)=>{ e.preventDefault(); });
  div.addEventListener('drop',(e)=>{
    e.preventDefault();
    let fromIndex = e.dataTransfer.getData('text/plain');
    let toIndex = div.dataset.index;
    swapGrid(fromIndex,toIndex);
  });
}

// 點擊空白處隱藏選單
document.addEventListener('click',(e)=>{
  if(!grid.contains(e.target) && !cellMenu.contains(e.target)){
    cellMenu.style.display='none';
  }
});

// 更換圖片
document.getElementById('changeImage').addEventListener('click',()=>{
  cellMenu.style.display='none';
  fileInput.click();
});
fileInput.addEventListener('change',e=>{
  if(e.target.files.length==0) return;
  const file=e.target.files[0];
  const reader=new FileReader();
  reader.onload=function(ev){
    currentCell.querySelector('img').src = ev.target.result;
    localStorage.setItem('ig_grid_'+currentCell.dataset.index, ev.target.result);
  }
  reader.readAsDataURL(file);
  fileInput.value='';
});

// 裁切圖片
document.getElementById('cropImage').addEventListener('click',()=>{
  cellMenu.style.display='none';
  const img = currentCell.querySelector('img');
  openCrop(img.src);
});

// 打開裁切視窗
function openCrop(src){
  imgObj = new Image();
  imgObj.src = src;
  imgObj.onload=function(){
    cropCanvas.width=400; cropCanvas.height=500;
    cropX=50; cropY=50; cropW=200; cropH=250;
    drawCrop();
    cropModal.style.display='flex';
  }
}

function drawCrop(){
  ctx.clearRect(0,0,cropCanvas.width,cropCanvas.height);
  let scale, offsetX=0, offsetY=0;
  if(imgObj.width/imgObj.height > cropCanvas.width/cropCanvas.height){
    scale = cropCanvas.height / imgObj.height;
    offsetX = (cropCanvas.width - imgObj.width*scale)/2;
  } else {
    scale = cropCanvas.width / imgObj.width;
    offsetY = (cropCanvas.height - imgObj.height*scale)/2;
  }
  ctx.drawImage(imgObj, offsetX, offsetY, imgObj.width*scale, imgObj.height*scale);
  ctx.strokeStyle='red';
  ctx.lineWidth=2;
  ctx.strokeRect(cropX,cropY,cropW,cropH);
}

// 拖拉裁切框
function isInside(x,y){ return x>=cropX && x<=cropX+cropW && y>=cropY && y<=cropY+cropH; }
cropCanvas.addEventListener('mousedown',e=>{
  let x=e.offsetX,y=e.offsetY;
  if(isInside(x,y)){ isDragging=true; dragOffsetX=x-cropX; dragOffsetY=y-cropY;}
  else if(Math.abs(x-(cropX+cropW))<10 && Math.abs(y-(cropY+cropH))<10){ isResizing=true; resizeStart={x,y,w:cropW,h:cropH};}
});
cropCanvas.addEventListener('mousemove',e=>{
  let x=e.offsetX,y=e.offsetY;
  if(isDragging){
    cropX=x-dragOffsetX; cropY=y-dragOffsetY;
    if(cropX<0) cropX=0; if(cropY<0) cropY=0;
    if(cropX+cropW>cropCanvas.width) cropX=cropCanvas.width-cropW;
    if(cropY+cropH>cropCanvas.height) cropY=cropCanvas.height-cropH;
    drawCrop();
  } else if(isResizing){
    let dx=x-resizeStart.x;
    cropW=resizeStart.w+dx;
    cropH=cropW*5/4;
    if(cropW<50){ cropW=50; cropH=cropW*5/4;}
    if(cropX+cropW>cropCanvas.width){ cropW=cropCanvas.width-cropX; cropH=cropW*5/4;}
    if(cropY+cropH>cropCanvas.height){ cropH=cropCanvas.height-cropY; cropW=cropH*4/5;}
    drawCrop();
  }
});
cropCanvas.addEventListener('mouseup',()=>{isDragging=false; isResizing=false;});

// 取消裁切
document.getElementById('cancelCrop').addEventListener('click',()=>{cropModal.style.display='none';});

// 確定裁切
document.getElementById('applyCrop').addEventListener('click',()=>{
  let scale, offsetX=0, offsetY=0;
  if(imgObj.width/imgObj.height > cropCanvas.width/cropCanvas.height){
    scale = cropCanvas.height / imgObj.height;
    offsetX = (cropCanvas.width - imgObj.width*scale)/2;
  } else {
    scale = cropCanvas.width / imgObj.width;
    offsetY = (cropCanvas.height - imgObj.height*scale)/2;
  }

  let sx = (cropX - offsetX)/scale;
  let sy = (cropY - offsetY)/scale;
  let sw = cropW/scale;
  let sh = cropH/scale;

  let tempCanvas = document.createElement('canvas');
  tempCanvas.width = sw; tempCanvas.height = sh;
  let tCtx = tempCanvas.getContext('2d');
  tCtx.drawImage(imgObj, sx, sy, sw, sh, 0, 0, sw, sh);

  currentCell.querySelector('img').src = tempCanvas.toDataURL();
  localStorage.setItem('ig_grid_'+currentCell.dataset.index, tempCanvas.toDataURL());
  cropModal.style.display='none';
});

// 拖曳排序交換
function swapGrid(fromIndex,toIndex){
  if(fromIndex===toIndex) return;
  let fromDiv = Array.from(grid.children).find(d=>d.dataset.index==fromIndex);
  let toDiv = Array.from(grid.children).find(d=>d.dataset.index==toIndex);
  let fromImg = fromDiv.querySelector('img').src;
  let toImg = toDiv.querySelector('img').src;
  fromDiv.querySelector('img').src = toImg;
  toDiv.querySelector('img').src = fromImg;
  localStorage.setItem('ig_grid_'+fromDiv.dataset.index, fromDiv.querySelector('img').src);
  localStorage.setItem('ig_grid_'+toDiv.dataset.index, toDiv.querySelector('img').src);

  // 更新順序
  let order = Array.from(grid.children).map(d=>parseInt(d.dataset.index));
  localStorage.setItem('ig_grid_order', JSON.stringify(order));
}
</script>
</body>
</html>

